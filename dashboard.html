<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AgriFlowTrack — Dashboard</title>
  <link rel="stylesheet" href="./dashboard.css">
</head>
<body>
  <aside class="sidebar">
    <h2>AgriFlowTrack</h2>
    <nav>
      <a href="./dashboard.html" class="active">Dashboard</a>
      <a href="./agricultural-products.html">Agricultural Products</a>
      <a href="./input-monitor.html">Agri Inputs</a>
      <a href="./perishable-products.html">Perishable Products</a>
      <a href="./post-harvest-monitor.html">Post-Harvest Monitor</a>
      <a href="./storage-conditions.html">Storage Conditions</a>
      <a href="./tracking-harvested-crops.html">Harvested Crops</a>
      <a href="./tracking-of-products.html">Tracking of Products</a>
      <a href="./market-data.html">Market Data</a>
      <button id="logoutBtn" class="logout">Logout</button>
    </nav>
  </aside>

  <main class="content">
    <div class="header">
      <div class="title">Dashboard</div>
      <div class="actions"><button class="btn btn-ghost" id="refreshBtn">Refresh</button></div>
    </div>

    <section class="cards">
      <div class="card"><div class="label">Products</div><div id="countProducts" class="value">—</div></div>
      <div class="card"><div class="label">Agri Inputs</div><div id="countInputs" class="value">—</div></div>
      <div class="card"><div class="label">Perishables</div><div id="countPerish" class="value">—</div></div>
      <div class="card"><div class="label">Post-Harvest</div><div id="countPost" class="value">—</div></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 12px">Latest Market Prices</h3>
      <table class="table" id="marketTable">
        <thead><tr><th>Market</th><th>Product</th><th>Price / Unit</th><th>Date</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
  // ---------- API base ----------
  function apiBase(){
    const i = location.pathname.indexOf('/public/');
    const root = i > -1 ? location.pathname.slice(0, i) : '';
    return location.origin + root + '/api/index.php'; // direct PHP router
  }
  const API = apiBase();

  // ---------- fetch wrapper (handles 401 + JSON/text) ----------
  async function request(url, opts = {}) {
    const r = await fetch(url, { credentials: 'include', ...opts });
    if (r.status === 401) {
      // not logged in on THIS host (localhost vs 127.0.0.1 matters)
      location.href = './login.html';
      throw new Error('Unauthorized');
    }
    const ct = r.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || r.statusText);
      return j;
    }
    const t = await r.text();
    if (!r.ok) throw new Error(t || r.statusText);
    return t;
  }

  // ---------- list helper ----------
  async function apiList(resource, params = {}) {
    const qs = new URLSearchParams(params).toString();
    return request(`${API}/${resource}${qs ? `?${qs}` : ''}`);
  }

  // ---------- robust counter ----------
  async function count(resource) {
    // Try efficient endpoint first (if you added /count on backend)
    try {
      const c = await request(`${API}/${resource}/count`);
      if (typeof c.count === 'number') return c.count;
    } catch (_) { /* fall back */ }

    // Fall back to GET all and infer the total from common shapes
    try {
      const data = await apiList(resource);
      if (Array.isArray(data)) return data.length;         // [ ... ]
      if (data && Array.isArray(data.data)) return data.data.length; // { data:[...], ... }
      if (typeof data.total === 'number') return data.total; // { total:n, ... }
    } catch (_) { /* ignore and return 0 */ }
    return 0;
  }

  // ---------- dashboard loaders ----------
  async function refreshCounts() {
    const [p, i, pe, ph] = await Promise.all([
      count('agricultural_products'),
      count('agri_inputs'),
      count('perishable_products'),
      count('post_harvest'),
    ]);
    document.getElementById('countProducts').textContent = p;
    document.getElementById('countInputs').textContent   = i;
    document.getElementById('countPerish').textContent   = pe;
    document.getElementById('countPost').textContent     = ph;
  }

  function esc(s){ return String(s ?? '').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

  async function refreshMarket() {
    try {
      const res = await apiList('market_data', { limit: 10, offset: 0 });
      const rows = Array.isArray(res) ? res : (res.data || []);
      const tb = document.querySelector('#marketTable tbody');
      tb.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(r.market_name||'')}</td>
                        <td>${esc(r.product||'')}</td>
                        <td>${esc(r.price_per_unit??'')}</td>
                        <td>${esc(r.price_date||'')}</td>`;
        tb.appendChild(tr);
      });
    } catch (_) {
      // leave table empty
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', () => {
    refreshCounts(); refreshMarket();
  });

  // kick off
  refreshCounts();
  refreshMarket();
</script>

</body>
</html>
