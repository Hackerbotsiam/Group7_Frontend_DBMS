<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AgriFlowTrack ‚Äî Perishable Products</title>
  <link rel="stylesheet" href="./dashboard.css">
</head>
<body>
  <aside class="sidebar">
    <h2>AgriFlowTrack</h2>
    <nav>
      <a href="./dashboard.html">Dashboard</a>
      <a href="./agricultural-products.html">Agricultural Products</a>
      <a href="./input-monitor.html">Agri Inputs</a>
      <a href="./perishable-products.html" class="active">Perishable Products</a>
      <a href="./post-harvest-monitor.html">Post-Harvest Monitor</a>
      <a href="./storage-conditions.html">Storage Conditions</a>
      <a href="./tracking-harvested-crops.html">Harvested Crops</a>
      <a href="./tracking-of-products.html">Tracking of Products</a>
      <a href="./market-data.html">Market Data</a>
      <button id="logoutBtn" class="logout">Logout</button>
    </nav>
  </aside>

  <main class="content">
    <div class="header">
      <div class="title">Perishable Products</div>
      <div class="actions">
        <input id="q" type="search" placeholder="Search in table‚Ä¶" style="min-width:220px">
        <button class="btn btn-ghost" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <section class="card">
      <h3 style="margin:0 0 12px">Create / Edit</h3>
      <form id="form">
        <input type="hidden" id="id" />
        <div><label for="name">Name</label><input id="name" type="text"></div>
        <div><label for="category">Category</label><input id="category" type="text"></div>
        <div><label for="storage_requirement">Storage Requirement</label><input id="storage_requirement" type="text"></div>
        <div><label for="shelf_life">Shelf Life</label><input id="shelf_life" type="text"></div>
        <div><label for="packaging_details">Packaging Details</label><input id="packaging_details" type="text"></div>
        <div><label for="supplier_info">Supplier Info</label><input id="supplier_info" type="text"></div>
        <div style="display:flex; gap:10px; align-items:center">
          <button class="btn btn-primary" type="submit">Save</button>
          <button class="btn btn-ghost" type="button" id="resetBtn">Reset</button>
          <span id="msg"></span>
        </div>
      </form>
    </section>

    <section class="card">
      <table class="table" id="table">
        <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Storage Requirement</th><th>Shelf Life</th><th>Packaging Details</th><th>Supplier Info</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    const RESOURCE='perishable_products';
function apiBase(){
  const i = location.pathname.indexOf('/public/');
  const root = i > -1 ? location.pathname.slice(0, i) : '';
  return location.origin + root + '/api/index.php';
}      const API=apiBase();
    async function apiList(r,p={}){ const qs=new URLSearchParams(p).toString(); const x=await fetch(API+'/'+r+(qs?('?'+qs):''),{credentials:'include'}); const j=await x.json().catch(()=>[]); if(!x.ok) throw new Error(j.error||'Fetch failed'); return j; }
    async function apiGet(r,id){ const x=await fetch(`${API}/${r}/${id}`,{credentials:'include'}); const j=await x.json(); if(!x.ok) throw new Error(j.error||'Fetch failed'); return j; }
    async function apiCreate(r,d){ const x=await fetch(`${API}/${r}`,{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}); const j=await x.json(); if(!x.ok) throw new Error(j.error||'Create failed'); return j; }
    async function apiUpdate(r,id,d){ const x=await fetch(`${API}/${r}/${id}`,{method:'PUT',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}); const j=await x.json(); if(!x.ok) throw new Error(j.error||'Update failed'); return j; }
    async function apiRemove(r,id){ const x=await fetch(`${API}/${r}/${id}`,{method:'DELETE',credentials:'include'}); const j=await x.json(); if(!x.ok) throw new Error(j.error||'Delete failed'); return j; }
    async function apiLogout(){ await fetch(API+'/logout',{method:'POST',credentials:'include'}).catch(()=>{}); }
    function esc(s){ return String(s??'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
    function toast(m){ let t=document.querySelector('.toast'); if(!t){t=document.createElement('div');t.className='toast';document.body.appendChild(t);} t.textContent=m; requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>t.classList.remove('show'),2600); }
    async function load(){ const rows=await apiList(RESOURCE).catch(()=>[]); window.__rows=rows; renderRows(rows); }
    function renderRows(rows){
      const q=document.getElementById('q').value.toLowerCase().trim();
      const list=q?rows.filter(r=>JSON.stringify(r).toLowerCase().includes(q)):rows;
      const tb=document.querySelector('#table tbody'); tb.innerHTML='';
      if(!list.length){ tb.innerHTML=`<tr><td colspan="9"><div style="padding:16px;color:#799488">No records found.</div></td></tr>`; return; }
      list.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.id}</td>
          <td>${esc(r.name||'')}</td>
          <td>${esc(r.category||'')}</td>
          <td>${esc(r.storage_requirement||'')}</td>
          <td>${esc(r.shelf_life||'')}</td>
          <td>${esc(r.packaging_details||'')}</td>
          <td>${esc(r.supplier_info||'')}</td>
          <td>${r.created_at??''}</td>
          <td class="actions">
            <button class="btn btn-ghost" onclick="editRow(${r.id})">‚úèÔ∏è Edit</button>
            <button class="btn btn-danger" onclick="delRow(${r.id})">üóë Delete</button>
          </td>`;
        tb.appendChild(tr);
      });
    }
    async function editRow(id){ const r=await apiGet(RESOURCE,id);
      ['name','category','storage_requirement','shelf_life','packaging_details','supplier_info'].forEach(k=>document.getElementById(k).value=r[k]??'');
      document.getElementById('id').value=r.id; toast('Loaded for editing'); }
    async function delRow(id){ if(!confirm('Delete record #'+id+'?')) return; await apiRemove(RESOURCE,id); toast('Record deleted'); load(); }
    document.getElementById('form').addEventListener('submit', async e=>{
      e.preventDefault();
      const id=id.value;
      const payload={ name:name.value, category:category.value, storage_requirement:storage_requirement.value, shelf_life:shelf_life.value, packaging_details:packaging_details.value, supplier_info:supplier_info.value };
      if(document.getElementById('id').value){ await apiUpdate(RESOURCE,document.getElementById('id').value,payload); toast('Updated successfully'); } else { await apiCreate(RESOURCE,payload); toast('Created successfully'); }
      e.target.reset(); load();
    });
    refreshBtn.addEventListener('click',load);
    q.addEventListener('input',()=>renderRows(window.__rows||[]));
    logoutBtn.addEventListener('click', async ()=>{ await apiLogout(); location.href='./login.html'; });
    load();
  </script>
</body>
</html>
